---
kind: pipeline
type: docker
name: Test

platform:
  os: linux
  arch: amd64

environment:
  PROD: PROD
  ARCH: ARCH

steps:
  - name: set_prod
    image: ubuntu
    commands:
    - echo "MY_ENV_VAR=$$PROD" > sourcme

  - name: write
    image: ubuntu
    commands:
      - source sourcme
      - echo "Hello world again from $MY_ENV_VAR!"

  - name: set_arch
    image: ubuntu
    commands:
    - echo "MY_ENV_VAR=$$ARCH" > sourcme

  - name: promote qa
    image: ubuntu
    commands:
      - source sourcme
      - echo "Hello world again from $MY_ENV_VAR!"
    when:
      event:
        - promote
      target:
        - qa
    depends_on:
      - write

  - name: promote prod
    image: ubuntu
    commands:
      - echo "Promoting to prod"
    when:
      event:
        - promote
      target:
        - prod
    depends_on:
      - promote qa
      - write

trigger:
  branch:
    - master

# ---
# kind: pipeline
# type: docker
# name: qa

# depends_on:
#   - Test

# platform:
#   os: linux
#   arch: amd64

# steps:
#   - name: write
#     image: ubuntu
#     commands:
#       - echo "Promoted to qa"

# trigger:
#   branch:
#     - master
#   event:
#     - promote
#   target:
#     - qa
